<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>文物規劃小程式（Excel 版）</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  :root{
    --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#22d3ee; --ok:#34d399; --warn:#f59e0b;
    --chip:#1f2937; --chip2:#0b2530;
  }
  *{box-sizing:border-box} body{margin:0;background:#0b1220;color:var(--text);font:15px/1.5 ui-sans-serif,system-ui}
  .wrap{max-width:1280px;margin:24px auto;padding:0 16px}
  h1{font-size:20px;margin:8px 0 16px}
  .row{display:flex;gap:16px;align-items:stretch;flex-wrap:wrap}
  .card{background:var(--panel);border:1px solid #1f2937;border-radius:12px;padding:16px;box-shadow:0 0 0 1px rgba(255,255,255,.02) inset}
  .w-100{flex:1 1 100%} .w-50{flex:1 1 50%} .w-33{flex:1 1 33%}
  label{display:inline-block;margin-right:8px;color:var(--muted)}
  input[type="number"]{background:#0b1322;border:1px solid #1f2937;color:#e5e7eb;border-radius:8px;padding:8px;min-width:80px}
  select{background:#0b1322;border:1px solid #1f2937;color:#e5e7eb;border-radius:8px;padding:8px}
  .chips{display:flex;gap:6px;flex-wrap:wrap}
  .chip{background:var(--chip);color:#d1d5db;border:1px solid #243244;padding:4px 8px;border-radius:999px;font-size:12px}
  .chip.gold{background:#3a2b00;color:#ffd86b;border-color:#5b4300}
  .chip.purple{background:#2e1e46;color:#d3bdf7;border-color:#4b2c7d}
  .list{max-height:540px;overflow:auto;border-top:1px solid #1f2937;margin-top:8px}
  .rowitem{display:grid;grid-template-columns:32px 1fr 90px 120px;gap:8px;align-items:center;padding:8px 0;border-bottom:1px solid #121926}
  .rowitem img{width:28px;height:28px;border-radius:6px;object-fit:cover;border:1px solid #263244;background:#0b1322}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid #1e293b;text-align:right}
  th:first-child,td:first-child{text-align:left}
  .muted{color:var(--muted)}
  .note{color:#93c5fd}
  .btn{background:#0b2530;color:#cbd5e1;border:1px solid #1f3440;border-radius:10px;padding:8px 10px;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px}
  .kpi{background:linear-gradient(180deg,#0d1624,#0b1320);border:1px solid #1b2838;border-radius:12px;padding:10px}
  .kpi h3{margin:0 0 6px;font-size:13px;color:#9fb5cc}
  .kpi .val{font-size:18px}
  .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .switch{display:inline-flex;gap:8px;align-items:center}
  .switch input{accent-color:#10b981}
  .right{overflow:auto}
  .sticky{position:sticky;top:0;background:var(--panel);z-index:2}
  .tablebox{max-height:520px;overflow:auto;border:1px solid #1d2736;border-radius:10px}
</style>
</head>
<body>
<div class="wrap">
  <h1>文物規劃小程式（Excel 版）</h1>

  <!-- 參數區 -->
  <div class="row">
    <div class="card w-50">
      <div class="flex">
        <label>1 點攻擊 =</label>
        <input id="atkWeight" type="number" step="0.01" value="1.00">
        <label>點屬性</label>
        <label style="margin-left:12px">1 點生命 =</label>
        <input id="hpWeight" type="number" step="0.01" value="0.90">
        <label>點屬性</label>
      </div>
      <div class="flex" style="margin-top:8px">
        <label>1 本金書 =</label>
        <input id="bookPrice" type="number" step="0.01" value="1.76">
        <label>元人民幣</label>
        <button class="btn" onclick="resetParams()">恢復預設</button>
        <div class="switch">
          <input id="aggTo12" type="checkbox" onchange="renderAll()">
          <label for="aggTo12">總結改為「當前 → Lv12」</label>
        </div>
      </div>
      <div class="chips" style="margin-top:10px">
        <span class="chip">資料來源：<b id="dataSrc" class="note">載入中…</b></span>
        <span class="chip">成本表：<b id="costInfo">預設</b></span>
        <span class="chip">分配比例：<b id="distInfo">平均</b></span>
      </div>
    </div>

    <div class="card w-50">
      <div class="grid">
        <div class="kpi"><h3>攻擊點+</h3><div class="val" id="kpiAtk">0.00</div></div>
        <div class="kpi"><h3>生命點+</h3><div class="val" id="kpiHp">0.00</div></div>
        <div class="kpi"><h3>等價屬性+</h3><div class="val" id="kpiEq">0.00</div></div>
        <div class="kpi"><h3>金書(本)</h3><div class="val" id="kpiBooks">0</div></div>
      </div>
      <div class="grid" style="margin-top:8px">
        <div class="kpi"><h3>金額(元)</h3><div class="val" id="kpiMoney">0.00</div></div>
        <div class="kpi"><h3>元/屬性點</h3><div class="val" id="kpiPP">0.00</div></div>
        <div class="kpi"><h3>資料狀態</h3><div class="val" id="kpiStatus">讀取中…</div></div>
        <div class="kpi"><h3>只顯示已勾選</h3>
          <div class="val"><input id="onlyChecked" type="checkbox" onchange="renderList()"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- 左：文物清單 -->
  <div class="row">
    <div class="card w-50">
      <div class="flex sticky">
        <label>搜尋：</label><input id="q" type="text" style="flex:1" placeholder="輸入文物名稱關鍵字" oninput="renderList()">
      </div>
      <div id="list" class="list"></div>
    </div>

    <!-- 右：效率排序 + 匯總 -->
    <div class="card w-50 right">
      <div class="chips" style="margin-bottom:8px">
        <span class="chip">排序：元/等價屬性點</span>
        <span class="chip">（只看下一級；勾「總結改為當前→Lv12」僅影響上方 KPI 與匯總）</span>
      </div>
      <div class="tablebox">
        <table id="rankTbl">
          <thead>
            <tr>
              <th>文物 / 標籤 / 兵種</th><th>步</th><th>弓</th><th>騎</th><th>攻擊</th><th>生命</th><th>等價屬性</th><th>金書</th><th>金額</th><th>元/屬性</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <h3 style="margin:14px 0 6px">標籤匯總</h3>
      <div class="tablebox">
        <table id="tagSum">
          <thead><tr><th>標籤</th><th>攻擊</th><th>生命</th><th>等價屬性</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <h3 style="margin:14px 0 6px">兵種匯總</h3>
      <div class="tablebox">
        <table id="troopSum">
          <thead><tr><th>兵種</th><th>攻擊</th><th>生命</th><th>等價屬性</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
const $ = (q)=>document.querySelector(q);
const fmtN = (n, d=2)=> (isFinite(n)? Number(n).toFixed(d):'0.00');
const rarityMap = (v)=>{
  v = (v||'').toString().trim().toLowerCase();
  if(['金','gold','legendary','l','g'].includes(v)) return '金';
  if(['紫','purple','epic','p','e'].includes(v)) return '紫';
  return v||'金';
};
const troopMap = (v)=>{
  v = (v||'').toString().trim().toLowerCase();
  if(['步','步兵','infantry','i'].includes(v)) return '步';
  if(['弓','弓兵','ranged','archer','r'].includes(v)) return '弓';
  if(['騎','騎兵','cavalry','c'].includes(v)) return '騎';
  if(['all','全軍','全','軍','army','leader'].includes(v)) return '全軍';
  return '全軍';
};
const labelMap = (v)=>{
  v = (v||'').toString().trim().toLowerCase();
  if(['攻','atk','attack','a'].includes(v)) return '攻';
  if(['生','hp','life','health','h'].includes(v)) return '生';
  return '攻';
};
const tagMap = (v, base)=>{
  v = (v||'').toString().trim();
  if(!v && base) return '基礎白字';
  if(/狂熱/.test(v)) return '狂熱';
  if(/隨隊|領主|隨從|lead/.test(v.toLowerCase())) return '領主隨隊';
  if(/基礎|白字|base/.test(v.toLowerCase())) return '基礎白字';
  return v || '基礎白字';
};

let BOOK_COST = {
  '金':[5,10,15,20,30,40,40,40,80,120,160],
  '紫':[5,10,15,20,30,40,40,40,80,120,160]
};
let DIST = Array(12).fill(1/12); // 12 個比例，代表每級「累積」占比；我們轉成「每級增量」
let INC = Array(11).fill(1/12);  // 11 個增量比例（由 DIST 推導）
let artifacts=[]; // [{name,rarity,icon,tagTotals:{步攻,弓攻,騎攻,步生,弓生,騎生}, tag, ...}]

function deriveINC(){
  // DIST 是 12 級「累積曲線」，長度允許 12 或 11；若是 12，先正規化再做差分
  let D = DIST.slice(0,12);
  let s = D.reduce((a,b)=>a+Number(b||0),0)||1;
  D = D.map(x=>Number(x||0)/s);
  let P=[0]; for(let i=0;i<12;i++) P[i+1]=P[i]+D[i];
  // 轉 11 個「當級增量」
  INC = [];
  for(let i=0;i<11;i++) INC[i] = (P[i+1]-P[i]) || (1/12);
}

function parseMainSheet(rows){
  // tall form -> fold into wide per artifact
  const byName = new Map();
  for(const r of rows){
    const name = r['Artifact']||r['名稱']||r['文物']||r['Name']||'';
    if(!name) continue;
    const rarity = rarityMap(r['Rarity']||r['稀有度']);
    const icon   = r['IconURL']||r['Icon']||'';
    const base   = (r['Base']||'').toString().trim();
    const tag    = tagMap(r['Kind']||r['標籤']||r['Tag'], base);
    const troop  = troopMap(r['Troop']||r['兵種']||r['Type']);
    const lab    = labelMap(r['Label']||r['屬性']||r['Attr']);
    const t12    = Number(r['Total12']||r['Lv12']||r['Total']||0) || 0;

    if(!byName.has(name)){
      byName.set(name,{
        name, rarity, icon, tag,
        // 12 級「總量」六格
        L12:{步攻:0,弓攻:0,騎攻:0,步生:0,弓生:0,騎生:0}
      });
    }
    const it = byName.get(name);
    const key = (troop==='步'?'步':troop==='弓'?'弓':troop==='騎'?'騎':'全軍');
    if(key==='全軍'){
      // 全軍：不分兵種，這筆在「標籤匯總」會計入，但不進入步/弓/騎拆分；這樣和你原本呈現一致
      // 如要攤分三兵種，改成下三行：
      // ['步','弓','騎'].forEach(tp => it.L12[tp+(lab==='攻'?'攻':'生')] += t12);
      it.L12['全軍'+(lab==='攻'?'攻':'生')] = (it.L12['全軍'+(lab==='攻'?'攻':'生')]||0)+t12;
    }else{
      const field = key + (lab==='攻'?'攻':'生');
      it.L12[field] += t12;
    }
  }
  artifacts = Array.from(byName.values());
}

function parseConfigSheet(rows){
  // 可選：金書成本(金/紫)、金書成本(紫)、分配比例（12 格）
  const keyOf = (k)=> Object.keys(rows[0]||{}).find(x=> (x||'').toString().trim().toLowerCase()===k);
  for(const r of rows){
    const k = (r[Object.keys(r)[0]]||'').toString().trim();
    if(!k) continue;
    if(/金書成本.*金/.test(k)){
      const line = Object.values(r).slice(1).map(Number).filter(x=>!isNaN(x));
      if(line.length>=11) BOOK_COST['金']=line.slice(0,11);
    }else if(/金書成本.*紫/.test(k)){
      const line = Object.values(r).slice(1).map(Number).filter(x=>!isNaN(x));
      if(line.length>=11) BOOK_COST['紫']=line.slice(0,11);
    }else if(/分配比例|dist/i.test(k)){
      const line = Object.values(r).slice(1).map(Number).filter(x=>!isNaN(x));
      if(line.length>=11){ // 接受 11 或 12
        DIST = (line.length===12? line : [...line,1]);
        deriveINC();
      }
    }
  }
  $('#costInfo').text('Excel');
  $('#distInfo').text('Excel');
}

function stepAddsFromL12(L12){
  // 根據 12 級總量 + INC（11 段）→ 回傳 11 個步進的「增量」
  const keys = ['步攻','弓攻','騎攻','步生','弓生','騎生','全軍攻','全軍生'];
  const steps = Array.from({length:11}, ()=> Object.create(null));
  for(let i=0;i<11;i++){
    for(const k of keys){
      const total = Number(L12[k]||0);
      steps[i][k] = total * (INC[i]||0);
    }
  }
  return steps;
}

function moneyPerStep(rarity, stepIdx){
  const books = (BOOK_COST[rarity]||BOOK_COST['金'])[stepIdx]||0;
  const money = books * Number($('#bookPrice').value||0);
  return {books, money};
}

function eqOf(add){ // add: {攻,生}
  const aW = Number($('#atkWeight').value||1);
  const hW = Number($('#hpWeight').value||0.9);
  return add.攻*aW + add.生*hW;
}

function resetParams(){
  $('#atkWeight').value = 1.00;
  $('#hpWeight').value = 0.90;
  $('#bookPrice').value = 1.76;
  renderAll();
}

function renderList(){
  const only = $('#onlyChecked').checked;
  const kw = ($('#q').value||'').trim().toLowerCase();
  const box = $('#list'); box.innerHTML='';
  for(const it of artifacts){
    if(kw && !it.name.toLowerCase().includes(kw)) continue;
    const id = 'id_'+ btoa(it.name).replace(/=/g,'');
    const row = document.createElement('div'); row.className='rowitem';
    if(only && !$('#'+id+'chk')?.checked) continue;

    row.innerHTML = `
      <input id="${id}chk" type="checkbox" onchange="renderAll()">
      <div class="flex" style="gap:8px;justify-content:flex-start">
        <img src="${it.icon||''}" onerror="this.style.visibility='hidden'"/>
        <div>
          <div>${it.name}</div>
          <div class="chips">
            <span class="chip ${it.rarity==='金'?'gold':'purple'}">${it.rarity}</span>
            <span class="chip">${it.tag||''}</span>
          </div>
        </div>
      </div>
      <div class="muted">當前等級</div>
      <div>
        <select id="${id}lv" onchange="renderAll()">
          ${Array.from({length:12},(_,i)=>`<option value="${i+1}" ${i===4?'selected':''}>Lv.${i+1}</option>`).join('')}
        </select>
      </div>
    `;
    box.appendChild(row);
  }
}

function computeSelections(onlyNextStep=true){
  // 回傳 {kpi, rowsForRank, tagSum, troopSum}
  let atk=0, hp=0, eq=0, books=0, money=0;
  const rows=[]; // for ranking table (只看下一級)
  const tagAgg = new Map(); // 狂熱/領主隨隊/基礎白字
  const troopAgg = new Map(); // 步/弓/騎/全軍

  const kw = ($('#q').value||'').trim().toLowerCase();

  for(const it of artifacts){
    const id = 'id_'+ btoa(it.name).replace(/=/g,'');
    const chk = $('#'+id+'chk'); const sel = $('#'+id+'lv');
    if(!chk || !sel || !chk.checked) continue;
    if(kw && !it.name.toLowerCase().includes(kw)) continue;

    const curLv = Number(sel.value||1); // 1~12
    const steps = stepAddsFromL12(it.L12);
    const startIdx = Math.max(1, Math.min(curLv,12))-1; // to next -> index

    // 只看下一級：組排行榜列
    if(startIdx<=10){
      const add = steps[startIdx];
      const atkThis = (add['步攻']||0)+(add['弓攻']||0)+(add['騎攻']||0)+(add['全軍攻']||0);
      const hpThis  = (add['步生']||0)+(add['弓生']||0)+(add['騎生']||0)+(add['全軍生']||0);
      const {books:bk, money:mn} = moneyPerStep(it.rarity, startIdx);
      const eqThis = eqOf({攻:atkThis, 生:hpThis});
      rows.push({
        name: it.name, tag: it.tag, rarity: it.rarity,
        step:`Lv.${startIdx+1}→${startIdx+2}`,
        步:(add['步攻']||0)+(add['步生']||0),
        弓:(add['弓攻']||0)+(add['弓生']||0),
        騎:(add['騎攻']||0)+(add['騎生']||0),
        攻:atkThis, 生:hpThis, 等價:eqThis, 金書:bk, 金額:mn
      });
    }

    // 匯總：看下一級 or 看到 12
    const endIdx = $('#aggTo12').checked ? 11 : Math.min(startIdx,10);
    for(let i=startIdx;i<=endIdx;i++){
      const add = steps[i]||{};
      const a = (add['步攻']||0)+(add['弓攻']||0)+(add['騎攻']||0)+(add['全軍攻']||0);
      const h = (add['步生']||0)+(add['弓生']||0)+(add['騎生']||0)+(add['全軍生']||0);
      const {books:bk, money:mn} = moneyPerStep(it.rarity, i);
      atk += a; hp += h; eq += eqOf({攻:a,生:h}); books += bk; money += mn;

      // 標籤匯總（全軍也在這裡）
      const tagKey = it.tag||'';
      const t0 = tagAgg.get(tagKey)||{攻:0,生:0};
      t0.攻 += a; t0.生 += h; tagAgg.set(tagKey,t0);

      // 兵種匯總（步/弓/騎/全軍分開）
      const troopAdds = {
        步:(add['步攻']||0)+(add['步生']||0),
        弓:(add['弓攻']||0)+(add['弓生']||0),
        騎:(add['騎攻']||0)+(add['騎生']||0),
        全軍:(add['全軍攻']||0)+(add['全軍生']||0)
      };
      for(const k of Object.keys(troopAdds)){
        const valAtk = (add[k==='步'?'步攻':k==='弓'?'弓攻':k==='騎'?'騎攻':'全軍攻']||0);
        const valHp  = (add[k==='步'?'步生':k==='弓'?'弓生':k==='騎'?'騎生':'全軍生']||0);
        const obj = troopAgg.get(k)||{攻:0,生:0}; obj.攻+=valAtk; obj.生+=valHp; troopAgg.set(k,obj);
      }
    }
  }

  // 排序：元/等價屬性
  rows.sort((a,b)=> (a.金額/(a.等價||1)) - (b.金額/(b.等價||1)));

  return {
    kpi:{atk,hp,eq,books,money},
    rows,
    tagSum: Array.from(tagAgg.entries()).map(([k,v])=>({k,攻:v.攻,生:v.生,等價:eqOf(v)})),
    troopSum: Array.from(troopAgg.entries()).map(([k,v])=>({k,攻:v.攻,生:v.生,等價:eqOf(v)}))
  };
}

function renderRank(rows){
  const tb = $('#rankTbl tbody'); tb.innerHTML='';
  for(const r of rows){
    const pp = r.金額 / (r.等價||1);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><span class="muted">${r.step}</span> ${r.name} <span class="chip">${r.tag}</span></td>
      <td>${fmtN(r.步)}</td><td>${fmtN(r.弓)}</td><td>${fmtN(r.騎)}</td>
      <td>${fmtN(r.攻)}</td><td>${fmtN(r.生)}</td><td>${fmtN(r.等價)}</td>
      <td>${r.金書}</td><td>${fmtN(r.金額)}</td><td>${fmtN(pp)}</td>
    `;
    tb.appendChild(tr);
  }
}

function renderSums(tagSum, troopSum){
  const t1 = $('#tagSum tbody'); t1.innerHTML='';
  tagSum.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.k}</td><td>${fmtN(r.攻)}</td><td>${fmtN(r.生)}</td><td>${fmtN(r.等價)}</td>`;
    t1.appendChild(tr);
  });
  const t2 = $('#troopSum tbody'); t2.innerHTML='';
  troopSum.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.k}</td><td>${fmtN(r.攻)}</td><td>${fmtN(r.生)}</td><td>${fmtN(r.等價)}</td>`;
    t2.appendChild(tr);
  });
}

function renderKPI(k){
  $('#kpiAtk').text(fmtN(k.atk));
  $('#kpiHp').text(fmtN(k.hp));
  $('#kpiEq').text(fmtN(k.eq));
  $('#kpiBooks').text(k.books);
  $('#kpiMoney').text(fmtN(k.money));
  $('#kpiPP').text(k.eq>0? fmtN(k.money/k.eq):'0.00');
}

function renderAll(){
  const res = computeSelections();
  renderRank(res.rows);
  renderSums(res.tagSum, res.troopSum);
  renderKPI(res.kpi);
}

async function loadExcel(){
  // 先讀 artifacts.xlsx（同目錄）
  try{
    const resp = await fetch('./artifacts.xlsx',{cache:'no-store'});
    if(!resp.ok) throw new Error('HTTP '+resp.status);
    const ab = await resp.arrayBuffer();
    const wb = XLSX.read(ab,{type:'array'});
    const main = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]||{}, {raw:true, defval:''});
    if(!main.length) throw new Error('空白 sheet');
    parseMainSheet(main);
    if(wb.SheetNames[1]){
      const conf = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[1]]||{}, {raw:true, defval:''});
      if(conf.length) parseConfigSheet(conf);
    }
    deriveINC();
    $('#dataSrc').text('artifacts.xlsx（同目錄）');
    $('#kpiStatus').text('讀取成功，文物數：'+artifacts.length);
  }catch(err){
    $('#dataSrc').text('內建示例（未找到 artifacts.xlsx）');
    $('#kpiStatus').text('讀取失敗：'+err.message);
    // 內建一點點資料，讓頁面可操作
    artifacts = [
      {name:'王國編年史',rarity:'金',icon:'',tag:'基礎白字',
       L12:{步攻:0,弓攻:0,騎攻:0,步生:0,弓生:0,騎生:0,'全軍攻':28.8,'全軍生':0}},
      {name:'鬼杖搖藥杵',rarity:'金',icon:'',tag:'狂熱',
       L12:{步攻:0,弓攻:0,騎攻:2.8,步生:0,弓生:0,騎生:1.2}}
    ];
    deriveINC();
  }
  renderList();
  renderAll();
}

loadExcel();
</script>
</body>
</html>
