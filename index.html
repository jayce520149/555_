<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>文物規劃小程式（Excel 版）</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  :root{--bg:#0b1220;--card:#0f172a;--line:#1f2937;--muted:#94a3b8;--fg:#e5e7eb;--chip:#192235;--chipfg:#cbd5e1;--acc:#38bdf8}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.6 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto}
  .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
  h1{font-size:20px;margin:0 0 12px}
  .row{display:grid;gap:12px}
  .row.c3{grid-template-columns:repeat(3,minmax(0,1fr))}
  .row.c4{grid-template-columns:repeat(4,minmax(0,1fr))}
  .row.c6{grid-template-columns:repeat(6,minmax(0,1fr))}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}
  .muted{color:var(--muted)}
  input,select{width:100%;padding:8px;border-radius:8px;border:1px solid #334155;background:#0b1326;color:var(--fg)}
  .pill{display:inline-flex;gap:8px;align-items:center;background:var(--chip);color:var(--chipfg);padding:4px 10px;border-radius:999px;font-size:12px}
  .btn{background:#111827;border:1px solid var(--line);color:#cbd5e1;padding:6px 10px;border-radius:8px;cursor:pointer}
  table{width:100%;border-collapse:collapse} th,td{padding:8px;border-bottom:1px solid var(--line)} th{text-align:left;color:#cbd5e1}
  .right{text-align:right}
  .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .tag{border:1px solid #374151;padding:2px 8px;border-radius:999px}
  .rar-gold{background:#3b2a00;border-color:#8b5d00;color:#ffd86b}
  .rar-purple{background:#26193b;border-color:#5b2ea6;color:#d3a6ff}
  .hint{font-size:12px;color:#9aa8bf;margin-top:6px}
</style>
</head>
<body>
<div class="wrap">
  <h1>文物性價比（M&X維護）</h1>

  <!-- 起始白字加成 + 最終白字總加成 -->
  <div class="card">
    <div class="muted" style="margin-bottom:6px">起始白字加成（僅做顯示；單位＝屬性點）</div>
    <div class="row c6">
      <div><div class="muted">步 攻擊</div><input id="initAtk步" type="number" step="0.01" value="0"></div>
      <div><div class="muted">弓 攻擊</div><input id="initAtk弓" type="number" step="0.01" value="0"></div>
      <div><div class="muted">騎 攻擊</div><input id="initAtk騎" type="number" step="0.01" value="0"></div>
      <div><div class="muted">步 生命</div><input id="initHp步"  type="number" step="0.01" value="0"></div>
      <div><div class="muted">弓 生命</div><input id="initHp弓"  type="number" step="0.01" value="0"></div>
      <div><div class="muted">騎 生命</div><input id="initHp騎"  type="number" step="0.01" value="0"></div>
    </div>
    <div class="hint">最終白字總加成 = 起始 +（基礎白字 + 狂熱）之合計；不含 領主隨隊 與 奇觀。</div>
    <table style="margin-top:8px">
      <thead><tr><th>兵種</th><th class="right">攻擊（起始→最終）</th><th class="right">生命（起始→最終）</th></tr></thead>
      <tbody id="finalBaseTotals"></tbody>
    </table>
  </div>

  <!-- 參數 -->
  <div class="card" style="margin-top:12px">
    <div class="row c4">
      <div><div class="muted">1 點攻擊 = 幾點屬性</div><input id="wAtk" type="number" step="0.01" value="1.00"></div>
      <div><div class="muted">1 點生命 = 幾點屬性</div><input id="wHp"  type="number" step="0.01" value="0.90"></div>
      <div><div class="muted">1 本金書 = 人民幣（元）</div><input id="price" type="number" step="0.01" value="1.76"></div>
      <div><div class="muted">資料來源</div><span id="dataSrc" class="pill">讀取中…</span></div>
    </div>
    <div class="hint">把 <b>artifacts.xlsx</b> 放在與本頁同資料夾並重新整理即可更新；欄位：Artifact, Rarity, Base, Kind, Troop, Label, Total12, IconURL。</div>
  </div>

  <!-- KPI -->
  <div class="row c4" style="margin-top:12px">
    <div class="card"><div class="muted">攻擊點＋</div><div id="kAtk" style="font-size:22px">0.00</div></div>
    <div class="card"><div class="muted">生命點＋</div><div id="kHp" style="font-size:22px">0.00</div></div>
    <div class="card"><div class="muted">等價屬性＋</div><div id="kEq" style="font-size:22px">0.00</div></div>
    <div class="card"><div class="muted">金書 / 金額（元）</div><div id="kCost" style="font-size:22px">0 / 0</div><div class="hint" id="kConv"></div></div>
  </div>

  <!-- 控制列 -->
  <div class="flex" style="margin:12px 0">
    <span class="pill">排序：元/等價屬性（所有已勾選文物之每一步）</span>
    <span id="cntArtifacts" class="pill">文物：已選 0 / 全部 0</span>
    <label class="pill"><input id="onlyChecked" type="checkbox" style="margin-right:6px">只顯示已勾選</label>
    <input id="search" placeholder="搜尋名稱…" style="max-width:260px"/>
  </div>

  <!-- 文物清單 -->
  <div class="card">
    <table>
      <thead>
        <tr>
          <th style="width:52px">選</th>
          <th>文物</th>
          <th style="width:80px">稀有度</th>
          <th style="width:200px">標籤</th>
          <th style="width:120px">當前等級</th>
          <th class="right" style="width:120px">本次攻擊</th>
          <th class="right" style="width:120px">本次生命</th>
          <th class="right" style="width:120px">等價屬性</th>
          <th class="right" style="width:120px">金書</th>
          <th class="right" style="width:120px">金額</th>
          <th class="right" style="width:120px">元/屬性</th>
        </tr>
      </thead>
      <tbody id="tblArtifacts"></tbody>
    </table>
  </div>

  <!-- 逐步性價比（推薦升級順序） -->
  <div class="card" style="margin-top:12px">
    <div class="flex"><span class="pill">逐步性價比（所有已勾選文物之每一步，以 元/等價屬性 排序）</span></div>
    <table>
      <thead>
        <tr>
          <th>文物 / 標籤 / 兵種</th>
          <th class="right">步</th><th class="right">弓</th><th class="right">騎</th>
          <th class="right">攻擊</th><th class="right">生命</th><th class="right">等價屬性</th>
          <th class="right">金書</th><th class="right">金額</th><th class="right">元/屬性</th>
        </tr>
      </thead>
      <tbody id="tblSteps"></tbody>
    </table>
  </div>

  <!-- 標籤匯總 -->
  <div class="card" style="margin-top:12px">
    <div class="pill">標籤匯總（狂熱 / 基礎白字 / 領主隨隊 / 奇觀 × 步/弓/騎/全軍）</div>
    <div id="tagTotals"></div>
  </div>

  <!-- 兵種匯總（不包含「奇觀」） -->
  <div class="card" style="margin-top:12px">
    <div class="pill">兵種匯總（排除「奇觀」）</div>
    <table>
      <thead><tr><th>兵種</th><th class="right">攻擊</th><th class="right">生命</th><th class="right">等價屬性</th></tr></thead>
      <tbody id="troopTotals"></tbody>
    </table>
  </div>

</div>

<script>
/* ---------- 工具 ---------- */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const nf = (n,d=2)=> (Math.round((+n||0)*10**d)/10**d).toFixed(d);

/* 等級累進（祝福、只對 Lv5→12 有意義） */
const CUM_PCT = {5:0.40,6:0.48,7:0.56,8:0.64,9:0.73,10:0.82,11:0.91,12:1.00};
/* 書本成本（以金書等價；fromLv: 5..11） */
const GOLD_BOOKS_FROM = {5:40/6, 6:80/6, 7:120/6, 8:40, 9:80, 10:120, 11:160};
const PURPLE_PER_GOLD = 6, BLUE_PER_GOLD = 36, GREEN_PER_GOLD = 216;

let RAW = [];     // from Excel
let ITEMS = [];   // grouped
let STATE = {weights:{atk:1, hp:0.9}, price:1.76, onlyChecked:false, search:''};

/* ---------- 載入 Excel ---------- */
async function loadExcel(){
  try{
    const res = await fetch('./artifacts.xlsx?ts='+Date.now(), {cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const ab = await res.arrayBuffer();
    const wb = XLSX.read(ab,{type:'array'}); const ws = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(ws,{defval:''});
    RAW = rows.map(r=>({
      name:String(r.Artifact).trim(),
      rarity:String(r.Rarity).trim(),
      base:String(r.Base).trim(),    // 狂熱 / 基礎白字 / 領主隨隊 / 奇觀
      kind:String(r.Kind).trim(),    // atk / hp
      troop:String(r.Troop).trim(),  // 步 / 弓 / 騎 / 全軍
      label:String(r.Label||'').trim(),
      total12:Number(r.Total12||0),
      icon:String(r.IconURL||'').trim()
    }));
    $('#dataSrc').textContent='資料來源：artifacts.xlsx（同目錄）';
  }catch(e){
    // 簡易示例
    RAW = [
      {name:'不朽之鏡',rarity:'金',base:'基礎白字',kind:'atk',troop:'步',label:'atk',total12:9,icon:''},
      {name:'不朽之鏡',rarity:'金',base:'基礎白字',kind:'atk',troop:'騎',label:'atk',total12:9,icon:''},
      {name:'王者之酒',rarity:'金',base:'奇觀',kind:'hp',troop:'全軍',label:'hp',total12:8,icon:''},
    ];
    $('#dataSrc').textContent='未找到 Excel/JSON，已使用 內建示例資料。';
  }
  groupItems();
  renderAll();
}

function groupItems(){
  const map = new Map();
  for(const r of RAW){
    if(!map.has(r.name)) map.set(r.name,{name:r.name,rarity:r.rarity,icon:r.icon,lv:5,checked:false,rows:[]});
    map.get(r.name).rows.push(r);
  }
  ITEMS = Array.from(map.values()).sort((a,b)=>a.name.localeCompare(b.name,'zh-Hant'));
}

/* ---------- 計算 ---------- */
function stepInc(total12, fromLv){
  if(!(fromLv>=5 && fromLv<=11)) return 0;
  const a = CUM_PCT[fromLv], b = CUM_PCT[fromLv+1];
  return (b-a)*(Number(total12)||0);
}

function collectStepRows(item, fromLv){
  const rows = [];
  for(const r of item.rows){ rows.push({base:r.base, kind:r.kind, troop:r.troop, inc:stepInc(r.total12, fromLv)}); }
  return rows;
}

/* 聚合到 兵種/標籤 */
function aggregate(rows, weights){
  const troops = {步:{atk:0,hp:0}, 弓:{atk:0,hp:0}, 騎:{atk:0,hp:0}, 全軍:{atk:0,hp:0}};
  const emptyTroops = ()=>({步:{atk:0,hp:0},弓:{atk:0,hp:0},騎:{atk:0,hp:0},全軍:{atk:0,hp:0}});
  const byTagTroop = {
    '狂熱':emptyTroops(),'基礎白字':emptyTroops(),'領主隨隊':emptyTroops(),'奇觀':emptyTroops()
  };
  for(const r of rows){
    const t = troops[r.troop] || troops.全軍;
    if(r.kind==='atk') t.atk += r.inc;
    if(r.kind==='hp')  t.hp  += r.inc;

    if(!byTagTroop[r.base]) byTagTroop[r.base]=emptyTroops(); // 防呆
    const bt = byTagTroop[r.base][r.troop] || byTagTroop[r.base].全軍;
    if(r.kind==='atk') bt.atk += r.inc;
    if(r.kind==='hp')  bt.hp  += r.inc;
  }
  const atk = troops.步.atk + troops.弓.atk + troops.騎.atk + troops.全軍.atk;
  const hp  = troops.步.hp  + troops.弓.hp  + troops.騎.hp  + troops.全軍.hp;
  const eq  = atk*weights.atk + hp*weights.hp;
  return {troops,byTagTroop,atk,hp,eq};
}

function calcAll(){
  const weights = STATE.weights, price = STATE.price;
  let kAtk=0,kHp=0,kEq=0,kGold=0;
  const emptyTroops = ()=>({步:{atk:0,hp:0},弓:{atk:0,hp:0},騎:{atk:0,hp:0},全軍:{atk:0,hp:0}});
  const tagSum = {'狂熱':emptyTroops(),'基礎白字':emptyTroops(),'領主隨隊':emptyTroops(),'奇觀':emptyTroops()};
  const troopSum = {步:{atk:0,hp:0},弓:{atk:0,hp:0},騎:{atk:0,hp:0},全軍:{atk:0,hp:0}}; // 排除「奇觀」後累加

  const listRows = [];

  for(const it of ITEMS){
    if(STATE.search && !it.name.includes(STATE.search)) continue;
    if(STATE.onlyChecked && !it.checked) continue;

    const chosen = Number(it.lv)||5;
    if(chosen>=12){
      // 滿級：本次 0
      listRows.push({it, agg:aggregate([], weights), gold:0, cost:0, unit:Infinity});
    }else{
      const start = Math.max(5, Math.min(11, chosen));
      let allRows=[], gold=0;
      for(let lv=start; lv<=11; lv++){
        allRows = allRows.concat(collectStepRows(it, lv));
        gold += GOLD_BOOKS_FROM[lv]||0;
      }
      const agg = aggregate(allRows, weights);
      const cost = gold*price, unit = agg.eq>0? cost/agg.eq : Infinity;
      listRows.push({it, agg, gold, cost, unit});

      if(it.checked){
        kAtk+=agg.atk; kHp+=agg.hp; kEq+=agg.eq; kGold+=gold;
        // 標籤匯總
        for(const tag of Object.keys(tagSum)){
          for(const t of ['步','弓','騎','全軍']){
            tagSum[tag][t].atk += agg.byTagTroop[tag][t].atk;
            tagSum[tag][t].hp  += agg.byTagTroop[tag][t].hp;
          }
        }
        // 兵種匯總（排除 奇觀）
        for(const t of ['步','弓','騎','全軍']){
          troopSum[t].atk += agg.byTagTroop['狂熱'][t].atk + agg.byTagTroop['基礎白字'][t].atk + agg.byTagTroop['領主隨隊'][t].atk;
          troopSum[t].hp  += agg.byTagTroop['狂熱'][t].hp  + agg.byTagTroop['基礎白字'][t].hp  + agg.byTagTroop['領主隨隊'][t].hp;
        }
      }
    }
  }

  return {listRows, kAtk,kHp,kEq,kGold, tagSum, troopSum};
}

/* ---------- 渲染 ---------- */
function renderAll(){
  STATE.weights.atk = Number($('#wAtk').value)||1;
  STATE.weights.hp  = Number($('#wHp').value)||0.9;
  STATE.price       = Number($('#price').value)||1.76;

  const totalCnt   = ITEMS.length;
  const checkedCnt = ITEMS.reduce((n, it) => n + (it.checked ? 1 : 0), 0);
  const badge = $('#cntArtifacts'); if (badge) badge.textContent = `文物：已選 ${checkedCnt} / 全部 ${totalCnt}`;

  const {listRows, kAtk,kHp,kEq,kGold, tagSum, troopSum} = calcAll();

  // 左表
  const body = $('#tblArtifacts'); body.innerHTML='';
  listRows.sort((a,b)=>a.unit-b.unit);
  for(const r of listRows){
    const tr = document.createElement('tr');

    const td0 = document.createElement('td');
    td0.innerHTML = `<input type="checkbox" ${r.it.checked?'checked':''} />`;
    td0.querySelector('input').addEventListener('change',e=>{ r.it.checked=e.target.checked; renderAll(); });
    tr.appendChild(td0);

    const nameTd = document.createElement('td');
    nameTd.textContent = r.it.name;  // 白字，無超連結
    tr.appendChild(nameTd);

    const rc = r.it.rarity==='金'?'rar-gold':(r.it.rarity==='紫'?'rar-purple':'');
    const tdR=document.createElement('td'); tdR.innerHTML=`<span class="tag ${rc}">${r.it.rarity||''}</span>`; tr.appendChild(tdR);

    const tags = Array.from(new Set(r.it.rows.map(x=>x.base))).join(' / ');
    const tdT=document.createElement('td'); tdT.innerHTML=`<div class="flex">${tags.split('/').map(t=>`<span class="tag">${t.trim()}</span>`).join(' ')}</div>`; tr.appendChild(tdT);

    const tdLv=document.createElement('td'); const sel=document.createElement('select');
    for(let i=5;i<=12;i++){ const o=document.createElement('option'); o.value=i; o.textContent='Lv.'+i; sel.appendChild(o); }
    sel.value=r.it.lv; sel.addEventListener('change',e=>{ r.it.lv=Number(e.target.value); renderAll(); });
    tdLv.appendChild(sel); tr.appendChild(tdLv);

    tr.appendChild(tdRight(nf(r.agg.atk)));
    tr.appendChild(tdRight(nf(r.agg.hp)));
    tr.appendChild(tdRight(nf(r.agg.eq)));
    const tdB=tdRight(nf(r.gold,2)); tdB.title = `${nf(r.gold*PURPLE_PER_GOLD,0)} 紫書`; tr.appendChild(tdB);
    tr.appendChild(tdRight(nf(r.cost)));
    tr.appendChild(tdRight(r.agg.eq>0?nf(r.cost/r.agg.eq):'—'));

    body.appendChild(tr);
  }

  // KPI
  $('#kAtk').textContent=nf(kAtk); $('#kHp').textContent=nf(kHp); $('#kEq').textContent=nf(kEq);
  $('#kCost').textContent=`${nf(kGold,2)} / ${nf(kGold*STATE.price)}`;
  $('#kConv').textContent=`≈ ${nf(kGold*PURPLE_PER_GOLD,0)} 紫書、${nf(kGold*BLUE_PER_GOLD,0)} 藍書、${nf(kGold*GREEN_PER_GOLD,0)} 綠書`;

  renderSteps();        // 逐步性價比（推薦順序）
  renderTotals(tagSum, troopSum);
  renderFinalBase(tagSum); // 最終白字總加成（起始 + 基礎白字 + 狂熱）
}

function tdRight(txt){ const td=document.createElement('td'); td.className='right'; td.textContent=txt; return td; }

/* 逐步性價比：列出所有勾選文物「當前→12」每一步，按元/等價屬性排序 */
function renderSteps(){
  const tb = $('#tblSteps'); tb.innerHTML='';
  const price = STATE.price, w = STATE.weights;
  const rows = [];

  for(const it of ITEMS){
    if(!it.checked) continue;
    const chosen = Number(it.lv)||5;
    if(chosen>=12) continue; // 滿級不再有步驟
    const start = Math.max(5, Math.min(11, chosen));
    for(let lv=start; lv<=11; lv++){
      const rws = collectStepRows(it, lv);
      const agg = aggregate(rws, w);
      const gold = GOLD_BOOKS_FROM[lv]||0;
      const cost = gold*price; const unit = agg.eq>0? cost/agg.eq : Infinity;
      const tags = Array.from(new Set(it.rows.map(x=>x.base))).join(' / ');
      rows.push({it, lv, agg, gold, cost, unit, tags});
    }
  }

  rows.sort((a,b)=>a.unit-b.unit);
  for(const r of rows){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><div class="flex"><b>Lv.${r.lv}→${r.lv+1}</b> ${r.it.name} <span class="tag">${r.tags}</span></div></td>
      <td class="right">${nf(r.agg.troops.步.atk)}</td>
      <td class="right">${nf(r.agg.troops.弓.atk)}</td>
      <td class="right">${nf(r.agg.troops.騎.atk)}</td>
      <td class="right">${nf(r.agg.atk)}</td>
      <td class="right">${nf(r.agg.hp)}</td>
      <td class="right">${nf(r.agg.eq)}</td>
      <td class="right" title="${nf(r.gold*PURPLE_PER_GOLD,0)} 紫書">${nf(r.gold,2)}</td>
      <td class="right">${nf(r.cost)}</td>
      <td class="right">${r.agg.eq>0?nf(r.cost/r.agg.eq):'—'}</td>`;
    tb.appendChild(tr);
  }
}

/* 標籤匯總 + 兵種匯總（兵種匯總排除奇觀） */
function renderTotals(tag, troop){
  const tg = $('#tagTotals'); tg.innerHTML='';
  const renderTag = (name,obj)=>{
    const tbl = document.createElement('table');
    tbl.innerHTML = `
      <thead><tr><th colspan="5" class="muted">${name}</th></tr>
      <tr><th>兵種</th><th class="right">攻擊</th><th class="right">生命</th><th class="right">等價屬性</th><th class="right">備註</th></tr></thead>
      <tbody>
        ${['步','弓','騎','全軍'].map(t=>{
          const atk=obj[t].atk, hp=obj[t].hp, eq=atk*STATE.weights.atk + hp*STATE.weights.hp;
          return `<tr><td>${t}</td><td class="right">${nf(atk)}</td><td class="right">${nf(hp)}</td><td class="right">${nf(eq)}</td><td></td></tr>`;
        }).join('')}
      </tbody>`;
    tg.appendChild(tbl);
  };
  renderTag('狂熱', tag['狂熱']);
  renderTag('基礎白字', tag['基礎白字']);
  renderTag('領主隨隊', tag['領主隨隊']);
  renderTag('奇觀', tag['奇觀']);

  const tt = $('#troopTotals'); tt.innerHTML='';
  for(const t of ['步','弓','騎','全軍']){
    const atk=troop[t].atk, hp=troop[t].hp, eq=atk*STATE.weights.atk + hp*STATE.weights.hp;
    const tr=document.createElement('tr'); tr.innerHTML=`<td>${t}</td><td class="right">${nf(atk)}</td><td class="right">${nf(hp)}</td><td class="right">${nf(eq)}</td>`;
    tt.appendChild(tr);
  }
}

/* 最終白字總加成（起始 + 基礎白字 + 狂熱，不含 領主隨隊/奇觀） */
function renderFinalBase(tagSum){
  const get = id => Number($(id).value)||0;
  const initAtk = {步:get('#initAtk步'),弓:get('#initAtk弓'),騎:get('#initAtk騎')};
  const initHp  = {步:get('#initHp步'), 弓:get('#initHp弓'),  騎:get('#initHp騎')};

  const tbody = $('#finalBaseTotals'); tbody.innerHTML='';
  ['步','弓','騎'].forEach(t=>{
    const addAtk = (tagSum['基礎白字'][t].atk + tagSum['狂熱'][t].atk);
    const addHp  = (tagSum['基礎白字'][t].hp  + tagSum['狂熱'][t].hp);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${t}</td>
      <td class="right">${nf(initAtk[t])} → ${nf(initAtk[t] + addAtk)}</td>
      <td class="right">${nf(initHp[t])}  → ${nf(initHp[t]  + addHp)}</td>`;
    tbody.appendChild(tr);
  });
}

/* 事件 */
['#wAtk','#wHp','#price','#initAtk步','#initAtk弓','#initAtk騎','#initHp步','#initHp弓','#initHp騎']
  .forEach(sel=>$(sel).addEventListener('input',renderAll));
$('#onlyChecked').addEventListener('change',e=>{STATE.onlyChecked=e.target.checked;renderAll();});
$('#search').addEventListener('input',e=>{STATE.search=e.target.value.trim();renderAll();});

loadExcel();
</script>
</body>
</html>
