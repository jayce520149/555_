<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>文物規劃小程式（Excel 內建版）</title>

  <!-- 你若有 <base>，請用 ./ 或直接拿掉。以下程式已做路徑保護，即使設成 "/" 也能讀到同目錄檔案。 -->
  <!-- <base href="./"> -->

  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --line:#1f2937;
      --ok:#10b981; --warn:#f59e0b; --bad:#ef4444; --link:#60a5fa;
      --chip:#334155; --gold:#eab308; --purple:#a78bfa;
    }
    html,body{margin:0;background:var(--bg);color:#e5e7eb;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;}
    a{color:var(--link)}
    h1{font-size:20px;margin:16px 0}
    .wrap{max-width:1200px;margin:0 auto;padding:16px;}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px}
    .pill{background:var(--chip);padding:2px 8px;border-radius:999px;font-size:12px;color:#cbd5e1}
    .muted{color:var(--muted)}
    .grid{display:grid;gap:8px}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid.cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}
    .btn{background:#1f2937;border:1px solid #374151;color:#e5e7eb;border-radius:10px;padding:8px 12px;cursor:pointer}
    .btn:hover{background:#243042}
    input[type="number"]{background:#111827;border:1px solid #334155;color:#e5e7eb;border-radius:8px;padding:6px 8px;width:110px}
    select{background:#111827;border:1px solid #334155;color:#e5e7eb;border-radius:8px;padding:6px 8px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{border-bottom:1px dashed var(--line);padding:10px 8px;vertical-align:top}
    th{color:#cbd5e1;text-align:left;background:#0b1220;position:sticky;top:0}
    tr:hover td{background:#0b1220}
    .num{text-align:right;white-space:nowrap}
    .gold{color:var(--gold);font-weight:600}
    .purple{color:var(--purple);font-weight:600}
    .badge{display:inline-flex;align-items:center;gap:6px}
    .tag{padding:2px 6px;border-radius:6px;background:#1f2937;border:1px solid #334155;font-size:12px;color:#cbd5e1}
    .small{font-size:12px}
    .stickyfoot{position:sticky;bottom:0;background:var(--panel);border-top:1px solid var(--line);padding:8px 12px}
    .kpi{display:flex;gap:18px;flex-wrap:wrap}
    .kpi .item{min-width:210px}
    .tbl{overflow:auto;max-height:60vh;border:1px solid var(--line);border-radius:12px}
    .avatar{width:28px;height:28px;border-radius:6px;border:1px solid #334155;object-fit:cover;background:#0b1220}
    .namecell{display:flex;align-items:center;gap:8px}
    .switch{display:inline-flex;align-items:center;gap:8px;cursor:pointer;user-select:none}
    .switch input{display:none}
    .switch .box{width:38px;height:22px;border:1px solid #334155;border-radius:999px;background:#0b1220;position:relative}
    .switch .dot{position:absolute;top:2px;left:2px;width:18px;height:18px;border-radius:999px;background:#475569;transition:all .15s}
    .switch input:checked + .box{background:#174a2f;border-color:#20895f}
    .switch input:checked + .box .dot{left:18px;background:#10b981}
    .hint{color:#93c5fd}
    .warn{color:#fbbf24}
    .ok{color:#10b981}
    .danger{color:#ef4444}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .center{display:flex;justify-content:center;align-items:center}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  </style>
</head>
<body>
<div class="wrap">

  <h1>文物規劃小程式（Excel 版）</h1>

  <div class="row">
    <div class="card grid cols-3" style="flex:1 1 600px">
      <div>
        <div class="small muted">1 點攻擊 = 幾點屬性</div>
        <input id="attackWeight" type="number" step="0.01" value="1"/>
      </div>
      <div>
        <div class="small muted">1 點生命 = 幾點屬性</div>
        <input id="hpWeight" type="number" step="0.01" value="0.9"/>
      </div>
      <div>
        <div class="small muted">1 本金書 = 人民幣（元）</div>
        <input id="bookPrice" type="number" step="0.01" value="1.76"/>
      </div>
    </div>

    <label class="card switch" title="僅顯示你已勾選的文物">
      <input id="onlyPicked" type="checkbox">
      <span class="box"><span class="dot"></span></span>
      <span>只顯示已勾選</span>
    </label>

    <div class="card">
      <div class="small muted">資料來源</div>
      <div id="dataSourceHint" class="hint">載入中…</div>
    </div>
  </div>

  <div class="hr"></div>

  <div class="kpi">
    <div class="item">
      <div class="small muted">總屬性（等價）</div>
      <div class="ok mono" id="kpi_equiv">0</div>
    </div>
    <div class="item">
      <div class="small muted">攻擊總和</div>
      <div class="mono" id="kpi_atk">0</div>
    </div>
    <div class="item">
      <div class="small muted">生命總和</div>
      <div class="mono" id="kpi_hp">0</div>
    </div>
    <div class="item">
      <div class="small muted">金書合計 / 預估金額</div>
      <div class="mono" id="kpi_cost">0 / 0</div>
    </div>
  </div>

  <div class="hr"></div>

  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div class="small muted">請勾選要升級的文物，設定「目前等級」；右側會列出每一步的增益與成本與效率排序。</div>
      <div><span class="pill">步 / 弓 / 騎 / 全軍</span> × <span class="pill">攻擊 / 生命</span> × <span class="pill">狂熱 / 領主隨隊 / 基礎</span></div>
    </div>
    <div class="hr"></div>

    <div class="grid cols-2" style="gap:16px">
      <div class="tbl" id="tbl_artifacts"></div>
      <div>
        <div class="small muted">效率排序（元 / 等價屬性點）</div>
        <div class="tbl" id="tbl_steps" style="max-height:50vh;margin-top:6px"></div>

        <div class="hr"></div>
        <div class="small muted">標籤屬性彙總（依：標籤 × 兵種）</div>
        <div class="tbl" id="tbl_tag_summary" style="max-height:38vh;margin-top:6px"></div>
      </div>
    </div>
  </div>

  <div class="stickyfoot small muted">
    ．把 <span class="mono">artifacts.xlsx</span> 放在與本頁同一目錄 → 重新整理即可更新資料。
  </div>
</div>

<script>
// -----------------------------
// 讀檔（有多重 fallback）
// -----------------------------
async function loadWorkbookOrJSON() {
  const tryFiles = ['artifacts.xlsx', 'artifacts.xlsx.xlsx', 'artifacts.json'];
  let lastErr = null;

  for (const f of tryFiles) {
    try {
      const url = new URL(f, window.location.href).toString() + `?v=${Date.now()}`;
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      const ct = res.headers.get('content-type') || '';
      if (ct.includes('application/json')) {
        const json = await res.json();
        window.__ARTIFACT_SOURCE__ = f;
        return { type: 'json', data: json };
      }
      const ab = await res.arrayBuffer();
      const wb = XLSX.read(ab, { type: 'array' });
      window.__ARTIFACT_SOURCE__ = f;
      return { type: 'xlsx', data: wb };
    } catch (e) {
      lastErr = e;
      console.warn(`讀取 ${f} 失敗：`, e);
    }
  }
  throw new Error(`未找到 Excel/JSON（最後錯誤：${lastErr}）`);
}

// -----------------------------
// Excel 解析
// 期望欄：Artifact / Rarity / Label / Troop / Kind / Total12 / IconURL
// 允許中文同義詞與大小寫差異
// -----------------------------
const HEADERS = {
  artifact: ['artifact','name','文物','文物名稱','名稱','道具','物品'],
  rarity: ['rarity','稀有','稀有度','顏色','顏色/稀有度','color'],
  label:  ['label','標籤','類別','分類','類型','tag'],
  troop:  ['troop','兵種','部隊','兵','t'],
  kind:   ['kind','屬性','類','stat','類別2','攻擊/生命','攻生命'],
  total12:['total12','max','lvl12','lv12','12級','最高','總屬性','12級屬性','Total'],
  icon:   ['icon','iconurl','image','img','縮圖','圖片','圖示']
};

function norm(s){ return String(s||'').trim().toLowerCase(); }
function findHeader(map, rawHeaders, key){
  const expects = HEADERS[key];
  for (const h of rawHeaders){
    const n = norm(h);
    if (expects.some(e => n.includes(e))) return h;
  }
  return null;
}

function sheetToAOA(ws){
  return XLSX.utils.sheet_to_json(ws, { header:1, raw:true });
}

function parseWorkbook(pack){
  // 允許：如果是 JSON，直接使用 { artifacts:[{...}], costs:{...} } 結構
  if (pack.type === 'json') return pack.data;

  const wb = pack.data;
  // 找到第一個看起來像資料表的工作表
  const wsName = wb.SheetNames[0];
  const ws = wb.Sheets[wsName];
  const aoa = sheetToAOA(ws);
  if (aoa.length < 2) throw new Error('Excel 資料表為空');

  const headerRow = aoa[0];
  const H = {
    artifact: findHeader(HEADERS, headerRow, 'artifact'),
    rarity:   findHeader(HEADERS, headerRow, 'rarity'),
    label:    findHeader(HEADERS, headerRow, 'label'),
    troop:    findHeader(HEADERS, headerRow, 'troop'),
    kind:     findHeader(HEADERS, headerRow, 'kind'),
    total12:  findHeader(HEADERS, headerRow, 'total12'),
    icon:     findHeader(HEADERS, headerRow, 'icon')
  };

  const idx = Object.fromEntries(Object.entries(H).map(([k,v])=>[k, headerRow.indexOf(v)]));

  const rows = aoa.slice(1).filter(r => r.some(v => v!==undefined && v!==null && String(v).trim()!==''));

  // Group by artifact
  const dict = new Map();
  for (const r of rows){
    const name = String(r[idx.artifact] ?? '').trim();
    if (!name) continue;
    const rarity = String(r[idx.rarity] ?? '').trim();
    const label  = String(r[idx.label] ?? '').trim();
    const troop  = String(r[idx.troop] ?? '').trim();
    const kind   = String(r[idx.kind] ?? '').trim(); // 攻擊/生命
    const v12    = Number(r[idx.total12] ?? 0);
    const icon   = String(r[idx.icon] ?? '').trim();

    if (!dict.has(name)){
      dict.set(name, { name, rarity, icon, lines: [] });
    }
    dict.get(name).lines.push({ label, troop, kind, total12: v12 });
  }
  // 也嘗試讀取成本工作表（可選）
  const costs = { purple:[5,10,15,20,25,30,35,40,40,80,120], gold:[5,10,15,20,25,30,35,40,40,80,120] };
  const costSheet = wb.SheetNames.find(n => /cost|成本|books/i.test(n));
  if (costSheet){
    try{
      const cw = wb.Sheets[costSheet];
      const costRows = XLSX.utils.sheet_to_json(cw, { defval:'' });
      for (const row of costRows){
        const r = norm(row.Rarity || row['稀有度'] || row['顏色'] || row['rarity']);
        const step = Number(row.Step || row['步驟'] || row['等級段'] || row['step'] || row['等級']) || 0;
        const books = Number(row.Books || row['金書'] || row['書本'] || row['books']) || 0;
        if (r.includes('紫')) costs.purple[step-1] = books;
        if (r.includes('金')) costs.gold[step-1] = books;
      }
    }catch(e){ console.warn('讀取成本表失敗：', e); }
  }

  return { artifacts:[...dict.values()], costs };
}

// -----------------------------
// 計算邏輯
// 1) 以 12 級總值為基準，把每列屬性拆到 11 個升級步驟
// 2) 預設「依步驟需要的金書數比例」分配（總和仍回到 12 級總值）
//    → 這讓每步驟「元/屬性點」近似一致；若未來 Excel 提供 step 權重，可覆寫。
// -----------------------------
function buildLevelPlan(artifacts, costs){
  // 累計每件文物的「每一步」增益（按列）
  // 回傳 dict: name -> { rarity, icon, steps:[{from,to,books,additions:[{label,troop,kind,val}], sumAtk, sumHp, equiv}] }
  const plan = new Map();

  for (const a of artifacts){
    const isGold = /金/.test(a.rarity);
    const costArr = isGold ? costs.gold : costs.purple; // 11 個數字（1→2 … 11→12）
    const totalBooks = costArr.reduce((s,v)=>s + (Number(v)||0),0) || 1;

    // 每一列（最多 5 列）依金書比例灌入每步
    const steps = Array.from({length:11}, (_,i)=>({
      from:i+1, to:i+2, books:Number(costArr[i]||0),
      additions:[], sumAtk:0, sumHp:0, equiv:0
    }));

    for (const ln of a.lines){
      const tot = Number(ln.total12||0);
      // 分配到 11 步
      for (let i=0;i<11;i++){
        const portion = tot * (Number(costArr[i]||0)/totalBooks);
        steps[i].additions.push({ label:ln.label, troop:ln.troop, kind:ln.kind, val:portion });
      }
    }
    plan.set(a.name, { rarity:a.rarity, icon:a.icon, steps, lines:a.lines });
  }
  return plan;
}

// 依使用者權重計算 step 等價屬性
function summarizeStep(step, weights){
  let atk=0, hp=0;
  for (const it of step.additions){
    if (/攻/.test(it.kind)) atk += Number(it.val||0);
    if (/生/.test(it.kind)) hp  += Number(it.val||0);
  }
  const equiv = atk*weights.atk + hp*weights.hp;
  step.sumAtk = atk; step.sumHp = hp; step.equiv = equiv;
  return step;
}

// -----------------------------
// UI
// -----------------------------
const $ = sel => document.querySelector(sel);

const state = {
  data:null,             // {artifacts:[], costs:{}}
  plan:null,             // Map(name -> steps[])
  picks:new Map(),       // name -> currentLevel (1..12)
  weights:{ atk:1, hp:0.9 },
  bookPrice:1.76,
  onlyPicked:false
};

function fmt(n, digits=2){
  if (!isFinite(n)) return '-';
  return Number(n).toFixed(digits).replace(/(\.0+)$|(?<=\.\d*[1-9])0+$/,'$1');
}
function money(n){ return fmt(n,2); }

function renderArtifactsTable(){
  const host = $('#tbl_artifacts');
  const rows = [];

  const header = `
    <table><thead><tr>
      <th style="width:36px"></th>
      <th>文物</th><th>稀有度</th>
      <th>目前等級</th>
      <th class="num">本次（從當前 → 12）攻擊</th>
      <th class="num">本次生命</th>
      <th class="num">等價屬性</th>
      <th class="num">金書合計</th>
      <th class="num">金額(元)</th>
    </tr></thead><tbody>`;

  for (const a of state.data.artifacts){
    const picked = state.picks.has(a.name);
    if (state.onlyPicked && !picked) continue;

    const lvl = picked ? state.picks.get(a.name) : 1;
    const summary = calcArtifactFromLevel(a.name, lvl);
    const rareCls = /金/.test(a.rarity) ? 'gold' : 'purple';
    const icon = a.icon ? `<img class="avatar" src="${a.icon}" alt="">` : `<div class="avatar"></div>`;

    rows.push(`
      <tr>
        <td><input type="checkbox" data-act="pick" data-name="${a.name}" ${picked?'checked':''}></td>
        <td>
          <div class="namecell">
            ${icon}
            <div>
              <div>${a.name}</div>
              <div class="small">
                ${a.lines.map(l => `<span class="tag">${l.label || '—'}｜${l.troop || '—'}｜${l.kind || '—'}</span>`).join(' ')}
              </div>
            </div>
          </div>
        </td>
        <td class="${rareCls}">${a.rarity||''}</td>
        <td>
          <select data-act="level" data-name="${a.name}">
            ${Array.from({length:12},(_,i)=>i+1).map(n=>`<option value="${n}" ${n==lvl?'selected':''}>Lv.${n}</option>`).join('')}
          </select>
        </td>
        <td class="num">${fmt(summary.atk)}</td>
        <td class="num">${fmt(summary.hp)}</td>
        <td class="num ok">${fmt(summary.equiv)}</td>
        <td class="num">${fmt(summary.books,0)}</td>
        <td class="num">${money(summary.books*state.bookPrice)}</td>
      </tr>
    `);
  }

  host.innerHTML = `<div style="min-width:600px">${header}${rows.join('')||'<tr><td colspan="9" class="muted">（無資料）</td></tr>'}</tbody></table></div>`;

  // 事件
  host.querySelectorAll('input[data-act="pick"]').forEach(el=>{
    el.addEventListener('change', e=>{
      const name = el.dataset.name;
      if (el.checked) state.picks.set(name, state.picks.get(name)||1);
      else state.picks.delete(name);
      refresh();
    });
  });
  host.querySelectorAll('select[data-act="level"]').forEach(el=>{
    el.addEventListener('change', e=>{
      const name = el.dataset.name;
      const lv = Number(el.value);
      state.picks.set(name, lv);
      refresh();
    });
  });
}

function calcArtifactFromLevel(name, currentLevel){
  // 從 currentLevel → 12 的總加成與成本
  const steps = state.plan.get(name)?.steps || [];
  const weights = state.weights;
  let atk=0,hp=0,books=0;
  for (const st of steps){
    if (st.from < currentLevel) continue;
    summarizeStep(st, weights);
    atk += st.sumAtk;
    hp  += st.sumHp;
    books += st.books;
  }
  return { atk, hp, books, equiv: atk*weights.atk + hp*weights.hp };
}

function renderStepsTable(){
  // 集合所有勾選文物的「每一步」並排序
  const rows = [];
  const weights = state.weights;

  for (const [name, lv] of state.picks.entries()){
    const info = state.plan.get(name);
    if (!info) continue;
    for (const st of info.steps){
      if (st.from < lv) continue;
      summarizeStep(st, weights);
      const price = st.books * state.bookPrice;
      const perAttr = st.equiv>0 ? (price / st.equiv) : Infinity;
      rows.push({
        name, from:st.from, to:st.to, books:st.books, atk:st.sumAtk, hp:st.sumHp, equiv:st.equiv,
        labelList: st.additions.map(a=>a.label||'').filter(Boolean),
        troopList: st.additions.map(a=>a.troop||'').filter(Boolean),
        perAttr, price
      });
    }
  }

  rows.sort((a,b)=>a.perAttr - b.perAttr);

  const host = $('#tbl_steps');
  const header = `
    <table><thead><tr>
      <th>文物 / 標籤 / 兵種</th>
      <th class="num">步驟</th>
      <th class="num">攻擊</th>
      <th class="num">生命</th>
      <th class="num">等價屬性</th>
      <th class="num">金書</th>
      <th class="num">金額(元)</th>
      <th class="num">元/屬性點</th>
    </tr></thead><tbody>`;
  const body = rows.map(r=>`
    <tr>
      <td>
        <div>${r.name}</div>
        <div class="small">${[...new Set(r.labelList)].map(x=>`<span class="tag">${x}</span>`).join(' ')}
        ${[...new Set(r.troopList)].map(x=>`<span class="tag">${x}</span>`).join(' ')}</div>
      </td>
      <td class="num">Lv.${r.from}→${r.to}</td>
      <td class="num">${fmt(r.atk)}</td>
      <td class="num">${fmt(r.hp)}</td>
      <td class="num ok">${fmt(r.equiv)}</td>
      <td class="num">${fmt(r.books,0)}</td>
      <td class="num">${money(r.price)}</td>
      <td class="num ${isFinite(r.perAttr)?'':'muted'}">${isFinite(r.perAttr)?money(r.perAttr):'—'}</td>
    </tr>
  `).join('') || '<tr><td colspan="8" class="muted">（尚未勾選文物或目前等級已達 12）</td></tr>';

  host.innerHTML = `<div style="min-width:700px">${header}${body}</tbody></table></div>`;
}

function renderTagSummary(){
  // 彙總：標籤 × 兵種（步/弓/騎/全軍）
  const buckets = {}; // key = label|troop -> {atk,hp}
  const add = (label,troop,kind,val) => {
    const k = `${label||'—'}|${troop||'—'}`;
    if (!buckets[k]) buckets[k]={atk:0,hp:0};
    if (/攻/.test(kind)) buckets[k].atk += val;
    if (/生/.test(kind)) buckets[k].hp  += val;
  };

  for (const [name, lv] of state.picks.entries()){
    const info = state.plan.get(name);
    if (!info) continue;
    for (const st of info.steps){
      if (st.from < lv) continue;
      for (const it of st.additions){
        add(it.label, it.troop, it.kind, Number(it.val||0));
      }
    }
  }

  // 轉表格資料
  const rows = Object.entries(buckets).map(([k,v])=>{
    const [label,troop] = k.split('|');
    const equiv = v.atk*state.weights.atk + v.hp*state.weights.hp;
    return {label,troop, atk:v.atk, hp:v.hp, equiv};
  }).sort((a,b)=>{
    // 先以標籤、再以兵種排序
    const sa = (a.label||'') + '|' + (a.troop||'');
    const sb = (b.label||'') + '|' + (b.troop||'');
    return sa.localeCompare(sb,'zh-Hant');
  });

  const host = $('#tbl_tag_summary');
  const header = `
    <table><thead><tr>
      <th>標籤</th><th>兵種</th>
      <th class="num">攻擊總和</th>
      <th class="num">生命總和</th>
      <th class="num">等價屬性</th>
    </tr></thead><tbody>`;
  const body = rows.map(r=>`
    <tr>
      <td>${r.label}</td>
      <td>${r.troop}</td>
      <td class="num">${fmt(r.atk)}</td>
      <td class="num">${fmt(r.hp)}</td>
      <td class="num ok">${fmt(r.equiv)}</td>
    </tr>
  `).join('') || '<tr><td colspan="5" class="muted">（尚未勾選）</td></tr>';

  host.innerHTML = `<div style="min-width:520px">${header}${body}</tbody></table></div>`;
}

function refreshKPIs(){
  let atk=0,hp=0,books=0;
  for (const [name, lv] of state.picks.entries()){
    const s = calcArtifactFromLevel(name, lv);
    atk += s.atk; hp += s.hp; books += s.books;
  }
  const equiv = atk*state.weights.atk + hp*state.weights.hp;
  $('#kpi_atk').textContent   = fmt(atk);
  $('#kpi_hp').textContent    = fmt(hp);
  $('#kpi_equiv').textContent = fmt(equiv);
  $('#kpi_cost').textContent  = `${fmt(books,0)} / ${money(books*state.bookPrice)}`;
}

function refresh(){
  // 重新建 plan（因 weights 只影響 step 等價，不影響分配）
  renderArtifactsTable();
  renderStepsTable();
  renderTagSummary();
  refreshKPIs();
}

// -----------------------------
// 初始化
// -----------------------------
(async function init(){
  try{
    const pack = await loadWorkbookOrJSON();
    $('#dataSourceHint').textContent = `資料來源：${window.__ARTIFACT_SOURCE__}（同目錄）`;
    state.data = parseWorkbook(pack);
  }catch(err){
    console.error(err);
    $('#dataSourceHint').innerHTML = '<span class="warn">未找到 Excel/JSON，已使用 內建示例資料。請把 <b>artifacts.xlsx</b> 放在同目錄，重新整理即可。</span>';

    // 內建最小示例（2 件，示意用；實戰請提供 artifacts.xlsx）
    state.data = {
      artifacts:[
        { name:'示例A', rarity:'金', icon:'', lines:[
          {label:'狂熱', troop:'步', kind:'攻擊', total12:12},
          {label:'狂熱', troop:'步', kind:'生命', total12:10}
        ]},
        { name:'示例B', rarity:'紫', icon:'', lines:[
          {label:'領主隨隊', troop:'全軍', kind:'攻擊', total12:6},
          {label:'領主隨隊', troop:'全軍', kind:'生命', total12:8}
        ]}
      ],
      costs:{ purple:[5,10,15,20,25,30,35,40,40,80,120], gold:[5,10,15,20,25,30,35,40,40,80,120] }
    };
  }

  state.plan = buildLevelPlan(state.data.artifacts, state.data.costs);

  // 事件
  $('#attackWeight').addEventListener('change', e=>{ state.weights.atk = Number(e.target.value||1); refresh(); });
  $('#hpWeight').addEventListener('change', e=>{ state.weights.hp = Number(e.target.value||0.9); refresh(); });
  $('#bookPrice').addEventListener('change', e=>{ state.bookPrice = Number(e.target.value||1.76); refresh(); });
  $('#onlyPicked').addEventListener('change', e=>{ state.onlyPicked = e.target.checked; renderArtifactsTable(); });

  renderArtifactsTable();
  renderStepsTable();
  renderTagSummary();
  refreshKPIs();
})();
</script>
</body>
</html>
